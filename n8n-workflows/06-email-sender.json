{
  "name": "06 - Email Sender",
  "nodes": [
    {
      "parameters": {},
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse command and determine action type
const command = $input.first().json.command; // 'send', 'reply', 'draft'
const args = $input.first().json.args || '';
const emailId = $input.first().json.emailId;

return [{
  json: {
    command: command,
    args: args,
    emailId: emailId,
    userId: $input.first().json.userId,
    chatId: $input.first().json.chatId,
    username: $input.first().json.username
  }
}];"
      },
      "name": "Parse Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT gmail_id, sender_name, sender_email, subject, body_text, thread_id FROM emails WHERE id = $1 AND user_id = $2",
        "additionalFields": {
          "parameters": [
            {
              "name": "email_id",
              "value": "={{ $json.emailId }}"
            },
            {
              "name": "user_id",
              "value": "={{ $json.userId }}"
            }
          ]
        }
      },
      "name": "Get Original Email",
      "type": "n8n-nodes-base.sqlite",
      "typeVersion": 2.2,
      "position": [650, 200],
      "credentials": {
        "sqlite": {
          "id": "ronkbot-db",
          "name": "ronkbot Database"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM writing_style WHERE user_id = $1 ORDER BY analysis_date DESC LIMIT 1",
        "additionalFields": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.userId }}"
            }
          ]
        }
      },
      "name": "Get Writing Style",
      "type": "n8n-nodes-base.sqlite",
      "typeVersion": 2.2,
      "position": [650, 400],
      "credentials": {
        "sqlite": {
          "id": "ronkbot-db",
          "name": "ronkbot Database"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build AI prompt for reply generation
const originalEmail = $('Get Original Email').first().json;
const style = $('Get Writing Style').first().json || {};

if (!originalEmail) {
  return [{ json: { error: 'Email not found' } }];
}

// Build style description
let styleDesc = 'professional but friendly';
if (style.greeting_style) {
  styleDesc = `${style.greeting_style} and ${style.sign_off_style || 'professional'}`;
}

const prompt = `You are helping write an email reply. Here is the context:

ORIGINAL EMAIL:
From: ${originalEmail.sender_name} <${originalEmail.sender_email}>
Subject: ${originalEmail.subject}

Body:
${originalEmail.body_text.substring(0, 2000)}

WRITING STYLE:
The user writes in a ${styleDesc} tone.
${style.common_phrases ? 'Common phrases they use: ' + style.common_phrases : ''}
${style.formality_score ? 'Formality level: ' + (style.formality_score > 0.5 ? 'formal' : 'casual') : ''}

TASK:
Generate 3 different reply options:
1. FORMAL - Professional, polite, business-like
2. CASUAL - Friendly, warm, conversational
3. BRIEF - Short, direct, to the point

For each option, provide:
- Subject line (if different from original)
- Full email body
- Brief explanation of the tone/style

Make sure the replies:
- Address the key points in the original email
- Match the user's writing style
- Are appropriate for the relationship with the sender
- Sound natural and human-written

Format as JSON with keys: formal, casual, brief`;

return [{
  json: {
    prompt: prompt,
    originalEmail: originalEmail,
    chatId: $input.first().json.chatId
  }
}];"
      },
      "name": "Build AI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "model": "gemini-3-flash",
        "options": {
          "temperature": 0.8,
          "maxOutputTokens": 2000
        }
      },
      "name": "Generate AI Replies",
      "type": "n8n-nodes-base.googlePaLmChatModel",
      "typeVersion": 1,
      "position": [1050, 300],
      "credentials": {
        "googlePalmApi": {
          "id": "gemini-credentials",
          "name": "Gemini API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response into structured options
const aiResponse = $input.first().json.response || $input.first().json.content;
const chatId = $input.first().json.chatId;

// Try to extract JSON from response
let options = {};
try {
  // Find JSON in the response
  const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
  if (jsonMatch) {
    options = JSON.parse(jsonMatch[0]);
  }
} catch (e) {
  console.log('Failed to parse JSON, using text fallback');
}

// Format for Telegram
let message = 'üìß **AI-Generated Reply Options**\n\n';
message += 'Replying to: *' + ($input.first().json.originalEmail?.subject || 'Email') + '*\n\n';

if (options.formal) {
  message += '**1Ô∏è‚É£ FORMAL**\n';
  message += options.formal.body || options.formal || 'Professional reply option\n';
  message += '\n';
}

if (options.casual) {
  message += '**2Ô∏è‚É£ CASUAL**\n';
  message += options.casual.body || options.casual || 'Friendly reply option\n';
  message += '\n';
}

if (options.brief) {
  message += '**3Ô∏è‚É£ BRIEF**\n';
  message += options.brief.body || options.brief || 'Short reply option\n';
  message += '\n';
}

message += 'Reply with the number (1, 2, or 3) to send that option, or type "custom" to write your own.';

// Store options for later retrieval
const storeOptions = JSON.stringify(options);

return [{
  json: {
    message: message,
    options: storeOptions,
    chatId: chatId,
    originalEmailId: $input.first().json.originalEmail?.gmail_id,
    threadId: $input.first().json.originalEmail?.thread_id
  }
}];"
      },
      "name": "Format Reply Options",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Reply Options",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "ronkbot Telegram"
        }
      }
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Parse Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Command": {
      "main": [
        [
          {
            "node": "Get Original Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Writing Style",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Original Email": {
      "main": [
        [
          {
            "node": "Build AI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Writing Style": {
      "main": [
        [
          {
            "node": "Build AI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Prompt": {
      "main": [
        [
          {
            "node": "Generate AI Replies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate AI Replies": {
      "main": [
        [
          {
            "node": "Format Reply Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Reply Options": {
      "main": [
        [
          {
            "node": "Send Reply Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["ronkbot", "gmail", "email", "send", "ai"]
}
