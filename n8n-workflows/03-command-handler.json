{
  "name": "03 - Command Handler",
  "nodes": [
    {
      "parameters": {},
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse command and arguments\nconst text = $input.first().json.text;\nconst parts = text.split(' ');\nconst command = parts[0].toLowerCase();\nconst args = parts.slice(1).join(' ');\n\n// Extract command name without /\nconst commandName = command.replace('/', '');\n\nreturn [{\n  json: {\n    command: commandName,\n    args: args,\n    fullText: text,\n    chatId: $input.first().json.chatId,\n    userId: $input.first().json.userId,\n    username: $input.first().json.username\n  }\n}];"
      },
      "name": "Parse Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "value": "help",
              "output": 0
            },
            {
              "value": "status",
              "output": 1
            },
            {
              "value": "remember",
              "output": 2
            },
            {
              "value": "recall",
              "output": 3
            },
            {
              "value": "clear",
              "output": 4
            },
            {
              "value": "read",
              "output": 5
            },
            {
              "value": "list",
              "output": 6
            },
            {
              "value": "exec",
              "output": 7
            }
          ]
        }
      },
      "name": "Route Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "ðŸ‘‹ Hey there! Here are the things I can help you with:\\n\\nðŸ’¬ **Chat** - Just message me naturally\\nðŸ“Š **/status** - Check your Mac's system status\\nðŸ§  **/remember [fact]** - I'll remember something for you\\nðŸ’­ **/recall** - Show what I remember\\nðŸ—‘ï¸ **/clear** - Clear conversation history\\nðŸ“ **/read [filepath]** - Read a text file\\nðŸ“‚ **/list [directory]** - List directory contents\\nâš¡ **/exec [command]** - Run a safe command\\n\\nJust chat naturally or use any command above! ðŸ˜Š",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Help Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [850, 100],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "ronku_bot"
        }
      }
    },
    {
      "parameters": {
        "command": "df -h",
        "cwd": "/Users/ronkuwonku"
      },
      "name": "Get Disk Usage",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "command": "vm_stat | head -5",
        "cwd": "/Users/ronkuwonku"
      },
      "name": "Get Memory",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Format status response\nconst diskOutput = $('Get Disk Usage').first().json.stdout || 'N/A';\nconst memOutput = $('Get Memory').first().json.stdout || 'N/A';\n\nconst message = `ðŸ“Š **System Status**\\n\\nðŸ’¾ **Disk Usage:**\\n\`\`\`\\n${diskOutput}\`\`\`\\n\\nðŸ§  **Memory:**\\n\`\`\`\\n${memOutput}\`\`\`\\n\\nâ±ï¸ Last updated: ${new Date().toLocaleString()}`;\n\nreturn [{\n  json: {\n    message: message,\n    chatId: $input.first().json.chatId\n  }\n}];"
      },
      "name": "Format Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 250]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Status",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1250, 250],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "ronku_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO memory (user_id, username, fact, timestamp) VALUES ($1, $2, $3, datetime('now'))",
        "additionalFields": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.userId }}"
            },
            {
              "name": "username",
              "value": "={{ $json.username }}"
            },
            {
              "name": "fact",
              "value": "={{ $json.args }}"
            }
          ]
        }
      },
      "name": "Save Memory",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "sqlite-credentials",
          "name": "ronku-bot-db"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "âœ… Got it! I'll remember that:\\n\\n\"{{ $json.args }}\"\\n\\nðŸ’¡ Use /recall to see everything I remember!",
        "additionalFields": {}
      },
      "name": "Confirm Remember",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1050, 400],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "ronku_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT fact FROM memory WHERE user_id = $1 ORDER BY timestamp DESC",
        "additionalFields": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.userId }}"
            }
          ]
        }
      },
      "name": "Get All Memory",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [850, 500],
      "credentials": {
        "postgres": {
          "id": "sqlite-credentials",
          "name": "ronku-bot-db"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format memory list\nconst items = $('Get All Memory').all();\n\nif (!items || items.length === 0) {\n  return [{\n    json: {\n      message: 'ðŸ§  I don\\'t remember anything yet!\\n\\nUse /remember to tell me things I should remember. ðŸ˜Š',\n      chatId: $input.first().json.chatId\n    }\n  }];\n}\n\nlet message = 'ðŸ§  **Here\\'s what I remember about you:**\\n\\n';\nitems.forEach((item, index) => {\n  message += `${index + 1}. ${item.json.fact}\\n`;\n});\n\nmessage += '\\nðŸ’¡ Use /remember to add more!';\n\nreturn [{\n  json: {\n    message: message,\n    chatId: $input.first().json.chatId\n  }\n}];"
      },
      "name": "Format Memory List",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Memory",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1250, 500],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "ronku_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM conversations WHERE user_id = $1",
        "additionalFields": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.userId }}"
            }
          ]
        }
      },
      "name": "Clear History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [850, 600],
      "credentials": {
        "postgres": {
          "id": "sqlite-credentials",
          "name": "ronku-bot-db"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "ðŸ§¹ **Conversation history cleared!**\\n\\nI'm starting fresh. What would you like to talk about? ðŸ˜Š",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Confirm Clear",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1050, 600],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "ronku_bot"
        }
      }
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Parse Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Command": {
      "main": [
        [
          {
            "node": "Route Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Command": {
      "main": [
        [
          {
            "node": "Help Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Disk Usage",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Memory",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Memory",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get All Memory",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clear History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Disk Usage": {
      "main": [
        [
          {
            "node": "Format Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Memory": {
      "main": [
        [
          {
            "node": "Format Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Status": {
      "main": [
        [
          {
            "node": "Send Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Memory": {
      "main": [
        [
          {
            "node": "Confirm Remember",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Memory": {
      "main": [
        [
          {
            "node": "Format Memory List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Memory List": {
      "main": [
        [
          {
            "node": "Send Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear History": {
      "main": [
        [
          {
            "node": "Confirm Clear",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["ronku-bot", "commands"]
}
